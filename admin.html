<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة المشرف – توب 10</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .fade-in { animation: fadeIn .6s ease-out both; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <header class="bg-indigo-700 text-white py-6 text-center shadow fade-in">
    <h1 class="text-2xl md:text-3xl font-bold">📊 لوحة المتابعة – أعلى 10 مستغفرين</h1>
    <p class="text-sm mt-2 opacity-80">يتم التحديث من Google Sheets مباشرة</p>
  </header>

  <main class="max-w-3xl mx-auto p-6">
    <div class="bg-white rounded-xl shadow-md p-6 fade-in">
      <table class="w-full table-auto border-collapse text-sm">
        <thead>
          <tr class="bg-indigo-50 text-indigo-900">
            <th class="border px-3 py-2">#</th>
            <th class="border px-3 py-2">الاسم</th>
            <th class="border px-3 py-2">العدد</th>
            <th class="border px-3 py-2">آخر تحديث</th>
          </tr>
        </thead>
        <tbody id="leaderboard"></tbody>
      </table>
    </div>
  </main>

  <footer class="text-center text-xs text-gray-500 p-4">
    هذه الصفحة مخصصة للمشرف فقط – لا تنشر الرابط
  </footer>

  <script>
    const SHEET_API = "https://script.google.com/macros/s/AKfycby01krGKnpXugyKeOwtnMdGork4gKHLGS4iS9Vo2gcN5bFd_J51S7Z2gnACbz-PRu1lGQ/exec";

    function animate(el, target) {
      const startVal = parseInt(el.textContent.replace(/,/g,'')) || 0;
      const dur = 700, t0 = performance.now();
      const step = t => {
        const p = Math.min((t - t0)/dur, 1);
        const v = Math.floor(startVal + (target - startVal)*p);
        el.textContent = v.toLocaleString('ar-EG');
        if (p<1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    async function loadTop10() {
      try {
        const res = await fetch(SHEET_API);     // doGet يعيد كل الصفوف مرتبة
        const data = await res.json();          // [[name,count,updated_at], ...] بدون الهيدر
        const tbody = document.getElementById("leaderboard");
        tbody.innerHTML = "";

        data.slice(0, 10).forEach((row, i) => {
          const [name, count, updated_at] = row;
          const tr = document.createElement("tr");
          tr.className = i % 2 === 0 ? "bg-white" : "bg-gray-50";
          tr.innerHTML = `
            <td class="border px-3 py-2 text-center">${i + 1}</td>
            <td class="border px-3 py-2">${name}</td>
            <td class="border px-3 py-2 text-center font-bold text-green-700"><span class="count">0</span></td>
            <td class="border px-3 py-2 text-center text-xs text-gray-500">${new Date(updated_at).toLocaleString("ar-EG")}</td>
          `;
          tbody.appendChild(tr);
          animate(tr.querySelector('.count'), Number(count||0));
        });
      } catch (err) {
        alert("تعذر تحميل البيانات من Google Sheets");
      }
    }

    loadTop10();
    setInterval(loadTop10, 30000); // تحديث كل 30 ثانية
  </script>
</body>
</html>
